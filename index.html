<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¬ éŒ¢è¦é‚„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <style>
        /* æ‰‹æ©Ÿ App é¢¨æ ¼åŸºç¤è¨­å®š */
        body { 
            background-color: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            padding-top: 60px; 
            padding-bottom: 90px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* é ‚éƒ¨å›ºå®šæ¨™é¡Œåˆ— */
        .app-header {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 60px;
            background: #ffffff;
            color: #0d6efd;
            z-index: 1030;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem; font-weight: 700;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* åº•éƒ¨å›ºå®šå°èˆªåˆ— */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; width: 100%; 
            min-height: 70px;
            background: #ffffff;
            z-index: 1030;
            display: flex; 
            flex-wrap: nowrap !important;
            justify-content: space-around; 
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #6c757d; background: none; border: none; padding: 10px 0; 
            flex: 1; 
            text-decoration: none; font-size: 0.75rem;
            transition: all 0.2s ease;
        }
        .nav-item-btn.active { color: #0d6efd; font-weight: bold; }
        .nav-item-btn i { font-size: 1.5rem; margin-bottom: 2px; }

        /* é é¢åˆ‡æ›å…§å®¹èˆ‡å‹•ç•« (ç§»æ¤è‡ªåƒä»€éº¼ App) */
        .main-container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .tab-content { 
            display: none; /* é è¨­å…¨éƒ¨éš±è— */
            animation: fadeIn 0.3s ease; /* åŠ å…¥æ·¡å…¥å‹•ç•« */
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* å¡ç‰‡èˆ‡è¼¸å…¥æ¡†æœ€ä½³åŒ– */
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 16px; padding: 20px !important; }
        .form-control, .form-select { 
            height: 50px; 
            font-size: 16px !important; 
            border-radius: 10px;
        }
        .btn { height: 50px; font-size: 1.1rem; border-radius: 10px; font-weight: bold; }

        /* è¡¨æ ¼èˆ‡æ¸…å–® */
        .custom-table-container {
            width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; 
            border: 1px solid #dee2e6; border-radius: 10px; background-color: white;
        }
        .custom-table-container table { min-width: 650px; margin-bottom: 0; }
        .list-group-item { border-left: none; border-right: none; padding: 15px 10px; }
        .list-group-item:first-child { border-top: none; }
        
        /* æ—¥æ›† */
        #calendar { background: white; padding: 10px; border-radius: 16px; font-size: 0.9em; }
        .fc .fc-toolbar { flex-wrap: wrap; gap: 8px; justify-content: space-between; }
        .fc .fc-toolbar-title { font-size: 1.2em !important; }
        .fc .fc-button { padding: 0.4em 0.6em; }
    </style>
</head>
<body>

<div class="app-header">
    <i class="bi bi-wallet2 me-2"></i> å¥½å‹è¨˜å¸³èˆ‡æ—¥æ›†
</div>

<div class="bottom-nav">
    <button class="nav-item-btn active" id="btn-add-debt" onclick="switchTab('add-debt')">
        <i class="bi bi-pencil-square"></i><span>è¨˜å¸³</span>
    </button>
    <button class="nav-item-btn" id="btn-view-debt" onclick="switchTab('view-debt')">
        <i class="bi bi-cash-coin"></i><span>çµç®—</span>
    </button>
    <button class="nav-item-btn" id="btn-history-debt" onclick="switchTab('history-debt')">
        <i class="bi bi-receipt"></i><span>æ˜ç´°</span>
    </button>
    <button class="nav-item-btn" id="btn-add-food" onclick="switchTab('add-food')">
        <i class="bi bi-cup-hot"></i><span>ç´€éŒ„é£²é£Ÿ</span>
    </button>
    <button class="nav-item-btn" id="btn-food-calendar" onclick="switchTab('food-calendar')">
        <i class="bi bi-calendar-check"></i><span>æ—¥æ›†</span>
    </button>
</div>

<div class="main-container">
    
    <div id="add-debt" class="tab-content" style="display: block;">
        <div class="card">
            <h4 class="mb-4 fw-bold">æ–°å¢ä¸€ç­†æ¬ æ¬¾</h4>
            <div class="mb-3">
                <label class="form-label text-muted small fw-bold">èª°å…ˆä»£å¢Šçš„ï¼Ÿ(å‚µä¸»)</label>
                <select id="debt-payer" class="form-select border-primary shadow-sm">
                    <option value="minn0213">minn0213</option>
                    <option value="topyoung0610">topyoung0610</option>
                    <option value="youyouyou.c">youyouyou.c</option>
                    <option value="iamfrank">iamfrank</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label text-muted small fw-bold">èª°æ¬ éŒ¢ï¼Ÿ(å‚µå‹™äºº)</label>
                <select id="debt-borrower" class="form-select border-danger shadow-sm">
                    <option value="minn0213">minn0213</option>
                    <option value="topyoung0610">topyoung0610</option>
                    <option value="youyouyou.c" selected>youyouyou.c</option>
                    <option value="iamfrank">iamfrank</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label text-muted small fw-bold">é‡‘é¡</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 fs-5">$</span>
                    <input type="number" id="debt-amount" class="form-control border-start-0 ps-0 fs-4 fw-bold text-primary" placeholder="0">
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label text-muted small fw-bold">ç²¾ç¢ºæ—¥æœŸèˆ‡æ™‚é–“</label>
                <input type="datetime-local" id="debt-date" class="form-control bg-light">
            </div>
            <button id="submit-debt-btn" class="btn btn-primary w-100 shadow-sm"><i class="bi bi-check-circle me-1"></i> å„²å­˜ç´€éŒ„</button>
        </div>
    </div>

    <div id="view-debt" class="tab-content">
        <div class="card">
            <h4 class="mb-3 fw-bold">æœ€çµ‚çµç®—çµæœ</h4>
            <div class="alert alert-primary py-2 px-3 small rounded-3 mb-3">
                <i class="bi bi-info-circle me-1"></i> è¡¨æ ¼å¯å‘å·¦æ»‘å‹•æ“ä½œé‚„æ¬¾ ğŸ‘‰
            </div>
            <div class="custom-table-container shadow-sm">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>èª°æ¬ éŒ¢ (å‚µå‹™äºº)</th>
                            <th>è©²çµ¦èª° (å‚µä¸»)</th>
                            <th>æ‡‰é‚„é‡‘é¡</th>
                            <th>é‚„æ¬¾æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="debt-summary-tbody">
                        <tr><td colspan="4" class="text-center py-4 text-muted">æ­£åœ¨è¨ˆç®—ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="history-debt" class="tab-content">
        <div class="card p-0 overflow-hidden">
            <h4 class="m-4 mb-2 fw-bold">æ‰€æœ‰æ¬ æ¬¾æ˜ç´°</h4>
            <p class="px-4 text-muted small">æœ€æ–°ç´€éŒ„åœ¨æœ€ä¸Šæ–¹ï¼š</p>
            <ul id="debt-history-list" class="list-group list-group-flush mb-2">
                <li class="list-group-item text-center py-4 text-muted">æ­£åœ¨è®€å–ä¸­...</li>
            </ul>
        </div>
    </div>

    <div id="add-food" class="tab-content">
        <div class="card">
            <h4 class="mb-4 fw-bold">ç´€éŒ„é£²é£Ÿ</h4>
            <div class="mb-4">
                <label class="form-label text-muted small fw-bold">ä»Šå¤©åƒäº†å“ªå®¶ï¼Ÿ</label>
                <input type="text" id="food-name" class="form-control border-warning shadow-sm" placeholder="ä¾‹å¦‚ï¼šéº¥ç•¶å‹å¤§éº¥å…‹">
            </div>
            <div class="mb-4">
                <label class="form-label text-muted small fw-bold">æ—¥æœŸ</label>
                <input type="date" id="food-date" class="form-control bg-light">
            </div>
            <button id="submit-food-btn" class="btn btn-warning w-100 shadow-sm text-dark"><i class="bi bi-send-fill me-1"></i> æ–°å¢é£²é£Ÿç´€éŒ„</button>
        </div>
    </div>

    <div id="food-calendar" class="tab-content">
        <div class="card p-2 shadow-sm">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtACSJz8x65TwuH3lgD_4-_bokVOX3edQ",
        authDomain: "wteu-3a1f4.firebaseapp.com",
        projectId: "wteu-3a1f4",
        storageBucket: "wteu-3a1f4.firebasestorage.app",
        messagingSenderId: "134165572647",
        appId: "1:134165572647:web:60b4bb8bac3a37bc057202"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let calendar; 

    // === æ–°å¢ï¼šç´” JavaScript é é¢åˆ‡æ›åŠŸèƒ½ ===
    window.switchTab = function(targetTab) {
        // 1. å®šç¾©æ‰€æœ‰çš„åˆ†é  ID
        const allTabs = ['add-debt', 'view-debt', 'history-debt', 'add-food', 'food-calendar'];
        
        // 2. é€éè¿´åœˆåˆ‡æ›é¡¯ç¤ºèˆ‡æŒ‰éˆ•æ¨£å¼
        allTabs.forEach(tab => {
            // æ§åˆ¶å€å¡Šé¡¯ç¤ºéš±è—
            document.getElementById(tab).style.display = (tab === targetTab) ? 'block' : 'none';
            // æ§åˆ¶æŒ‰éˆ•é«˜äº®ç‹€æ…‹
            document.getElementById('btn-' + tab).classList.toggle('active', tab === targetTab);
        });

        // 3. è™•ç†åˆ‡æ›æ™‚éœ€è¦é‡æ–°è¼‰å…¥æˆ–æ¸²æŸ“çš„å‹•ä½œ
        if (targetTab === 'view-debt' || targetTab === 'history-debt') {
            loadDebts(); // åˆ‡æ›åˆ°çµç®—æˆ–æ˜ç´°æ™‚ï¼Œé‡æ–°è®€å–è³‡æ–™
        } else if (targetTab === 'food-calendar' && calendar) {
            calendar.render(); // åˆ‡æ›åˆ°æ—¥æ›†æ™‚ï¼Œé‡æ–°æ¸²æŸ“é¿å…ç ´åœ–
        }
    };
    // =====================================

    // æ–°å¢æ¬ æ¬¾
    document.getElementById('submit-debt-btn').addEventListener('click', async () => {
        const payer = document.getElementById('debt-payer').value;
        const borrower = document.getElementById('debt-borrower').value;
        const amount = parseFloat(document.getElementById('debt-amount').value);
        const date = document.getElementById('debt-date').value;

        if (!amount || !date || payer === borrower) {
            alert('è«‹ç¢ºèªé‡‘é¡ã€æ—¥æœŸï¼Œä¸”å‚µä¸»èˆ‡å‚µå‹™äººä¸èƒ½æ˜¯åŒä¸€äººï¼');
            return;
        }

        try {
            await addDoc(collection(db, "debts"), {
                payer: payer,
                borrower: borrower,
                amount: amount,
                datetime: date,
                recordedBy: "å…±åŒæ“ä½œ" 
            });
            alert('æ¬ æ¬¾ç´€éŒ„æˆåŠŸï¼');
            document.getElementById('debt-amount').value = '';
            loadDebts(); 
        } catch (e) {
            console.error("å¯«å…¥éŒ¯èª¤: ", e);
            alert("å¯«å…¥è³‡æ–™åº«å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase è¨­å®šã€‚");
        }
    });

    // è™•ç†é‚„æ¬¾
    window.processRepayment = async function(debtor, creditor, amountType, maxAmount, index) {
        let repayAmount = 0;
        if (amountType === 'all') {
            repayAmount = parseFloat(maxAmount);
        } else {
            const inputVal = document.getElementById(`repay-input-${index}`).value;
            repayAmount = parseFloat(inputVal);
        }

        if (!repayAmount || repayAmount <= 0 || repayAmount > maxAmount) {
            alert(`è«‹è¼¸å…¥æœ‰æ•ˆçš„é‚„æ¬¾é‡‘é¡ï¼(æœ€å¤šä¸èƒ½è¶…é $${maxAmount})`);
            return;
        }

        if (!confirm(`ç¢ºå®šè¦ç´€éŒ„ã€Œ${debtor}ã€é‚„æ¬¾ $${repayAmount} çµ¦ã€Œ${creditor}ã€å—ï¼Ÿ`)) {
            return;
        }

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const localNow = now.toISOString().slice(0,16);

        try {
            await addDoc(collection(db, "debts"), {
                payer: debtor, 
                borrower: creditor, 
                amount: repayAmount,
                datetime: localNow,
                recordedBy: "ç³»çµ±é‚„æ¬¾æ“ä½œ" 
            });
            alert('é‚„æ¬¾æˆåŠŸï¼ç³»çµ±å·²æ›´æ–°é¤˜é¡ã€‚');
            loadDebts(); 
        } catch (e) {
            console.error("é‚„æ¬¾å¤±æ•—: ", e);
            alert("é‚„æ¬¾ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šã€‚");
        }
    };

    // è®€å–æ¬ æ¬¾è³‡æ–™èˆ‡è¨ˆç®—
    async function loadDebts() {
        const tbody = document.getElementById('debt-summary-tbody');
        const historyList = document.getElementById('debt-history-list'); 
        
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>æ­£åœ¨è¨ˆç®—ä¸­...</td></tr>';
        historyList.innerHTML = '<li class="list-group-item text-center py-4 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>æ­£åœ¨è®€å–ä¸­...</li>';
        
        try {
            const querySnapshot = await getDocs(collection(db, "debts"));
            const userList = ["minn0213", "topyoung0610", "youyouyou.c", "iamfrank"];
            let allDebts = []; 
            let pairwise = {};
            userList.forEach(u1 => {
                pairwise[u1] = {};
                userList.forEach(u2 => { pairwise[u1][u2] = 0; });
            });
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                allDebts.push(data); 
                if(pairwise[data.payer] !== undefined && pairwise[data.borrower] !== undefined) {
                    pairwise[data.payer][data.borrower] += data.amount;
                }
            });

            allDebts.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            historyList.innerHTML = '';
            if (allDebts.length === 0) {
                historyList.innerHTML = '<li class="list-group-item text-center text-muted py-4">ç›®å‰æ²’æœ‰ä»»ä½•æ¬ æ¬¾ç´€éŒ„ã€‚</li>';
            } else {
                allDebts.forEach(debt => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    const isRepayment = debt.recordedBy && debt.recordedBy.includes("ç³»çµ±é‚„æ¬¾æ“ä½œ");
                    const actionText = isRepayment ? "é‚„çµ¦" : "å¹«å¢Š";
                    const actionColor = isRepayment ? "text-success" : "text-danger";
                    const icon = isRepayment ? `<i class="bi bi-arrow-return-right text-success me-1"></i>` : `<i class="bi bi-cash text-danger me-1"></i>`;

                    li.innerHTML = `
                        <div>
                            <div class="fw-bold mb-1" style="font-size: 0.95rem;">
                                ${icon} <span class="text-primary">${debt.payer}</span> ${actionText} <span class="${actionColor}">${debt.borrower}</span>
                            </div>
                            <div class="text-muted" style="font-size: 0.75rem;">${debt.datetime.replace('T', ' ')}</div>
                        </div>
                        <div class="fw-bold fs-5 ${actionColor}">$${debt.amount}</div>
                    `;
                    historyList.appendChild(li);
                });
            }

            let settlementData = [];
            for (let i = 0; i < userList.length; i++) {
                for (let j = i + 1; j < userList.length; j++) {
                    let u1 = userList[i];
                    let u2 = userList[j];
                    let u1_owes_u2 = pairwise[u2][u1]; 
                    let u2_owes_u1 = pairwise[u1][u2]; 
                    
                    if (u1_owes_u2 > u2_owes_u1) {
                        settlementData.push({ debtor: u1, creditor: u2, amount: u1_owes_u2 - u2_owes_u1 });
                    } else if (u2_owes_u1 > u1_owes_u2) {
                        settlementData.push({ debtor: u2, creditor: u1, amount: u2_owes_u1 - u1_owes_u2 });
                    }
                }
            }

            tbody.innerHTML = '';
            if (settlementData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success py-4 fw-bold fs-5"><i class="bi bi-emoji-smile me-2"></i>ç›®å‰å¤§å®¶äº’ä¸ç›¸æ¬ ï¼Œå¤ªæ£’äº†ï¼</td></tr>';
            } else {
                settlementData.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="white-space: nowrap;"><span class="badge bg-light text-dark border p-2">${item.debtor}</span></td>
                        <td style="white-space: nowrap;"><span class="badge bg-light text-primary border p-2">${item.creditor}</span></td>
                        <td class="text-danger fw-bold fs-5" style="white-space: nowrap;">$${item.amount}</td>
                        <td>
                            <div class="input-group flex-nowrap" style="min-width: 250px;">
                                <input type="number" class="form-control form-control-sm border-primary" id="repay-input-${index}" placeholder="é‡‘é¡" max="${item.amount}">
                                <button class="btn btn-outline-primary px-2" onclick="processRepayment('${item.debtor}', '${item.creditor}', 'partial', ${item.amount}, ${index})">éƒ¨åˆ†é‚„</button>
                                <button class="btn btn-success px-2" onclick="processRepayment('${item.debtor}', '${item.creditor}', 'all', ${item.amount}, ${index})">å…¨é‚„æ¸…</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–è³‡æ–™åº«æ¬Šé™ã€‚</td></tr>';
            historyList.innerHTML = '<li class="list-group-item text-center text-danger py-4">è®€å–æ˜ç´°å¤±æ•—ã€‚</li>';
        }
    }

    // æ–°å¢é£²é£Ÿç´€éŒ„
    document.getElementById('submit-food-btn').addEventListener('click', async () => {
        const food = document.getElementById('food-name').value.trim();
        const date = document.getElementById('food-date').value;

        if (!food || !date) {
            alert('è«‹è¼¸å…¥é£Ÿç‰©åç¨±èˆ‡æ—¥æœŸï¼');
            return;
        }

        try {
            await addDoc(collection(db, "foods"), {
                food: food,
                date: date 
            });
            alert('é£²é£Ÿç´€éŒ„æˆåŠŸï¼');
            document.getElementById('food-name').value = '';
            loadFoodsToCalendar(); 
        } catch (e) {
            console.error("å¯«å…¥éŒ¯èª¤: ", e);
            alert("å¯«å…¥è³‡æ–™åº«å¤±æ•—ã€‚");
        }
    });

    function initCalendar() {
        if (!calendar) {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                contentHeight: 'auto', 
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'today'
                },
                buttonText: { today: 'ä»Šå¤©' },
                events: [] 
            });
            calendar.render();
        }
        loadFoodsToCalendar();
    }

    async function loadFoodsToCalendar() {
        try {
            const querySnapshot = await getDocs(collection(db, "foods"));
            let events = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                events.push({
                    title: data.food, 
                    start: data.date || data.datetime, 
                    allDay: true,
                    color: '#ffc107', 
                    textColor: '#000'
                });
            });
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        } catch (e) {
            console.error("è®€å–æ—¥æ›†éŒ¯èª¤:", e);
        }
    }

    // ç¶²é ä¸€è¼‰å…¥å°±ç›´æ¥è®€å–
    window.onload = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        
        const localNow = now.toISOString().slice(0,16);
        document.getElementById('debt-date').value = localNow;
        
        const localDate = now.toISOString().slice(0,10);
        document.getElementById('food-date').value = localDate;
        
        loadDebts();
        initCalendar();
    };
</script>
</body>
</html>
