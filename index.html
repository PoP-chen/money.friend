<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友記帳與飲食日曆</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none !important; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; }
        #app-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        #calendar { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        /* 這裡修正了手機版無法滑動的問題！ */
        .table-responsive { border-radius: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="login-section" class="card p-5 mt-5">
        <h2 class="text-center mb-4">系統登入</h2>
        <div class="mb-3">
            <label class="form-label">帳號</label>
            <input type="text" id="login-username" class="form-control" placeholder="輸入帳號">
        </div>
        <div class="mb-3">
            <label class="form-label">密碼</label>
            <input type="password" id="login-password" class="form-control" placeholder="輸入密碼">
        </div>
        <button id="login-btn" class="btn btn-primary w-100">登入</button>
        <p id="login-error" class="text-danger mt-3 text-center hidden">帳號或密碼錯誤！</p>
    </div>

    <div id="main-section" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
            <h3 id="welcome-msg">歡迎！</h3>
            <button id="logout-btn" class="btn btn-outline-danger btn-sm">登出</button>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="add-debt-tab" data-bs-toggle="tab" data-bs-target="#add-debt" type="button" role="tab">新增欠款</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-debt-tab" data-bs-toggle="tab" data-bs-target="#view-debt" type="button" role="tab">欠款總覽(還款)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-debt-tab" data-bs-toggle="tab" data-bs-target="#history-debt" type="button" role="tab">欠款詳細紀錄</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="add-food-tab" data-bs-toggle="tab" data-bs-target="#add-food" type="button" role="tab">今日吃什麼</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#food-calendar" type="button" role="tab">飲食日曆</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active card p-4" id="add-debt" role="tabpanel">
                <h4>新增一筆欠款</h4>
                <div class="mb-3">
                    <label class="form-label">誰先代墊的？(債主)</label>
                    <select id="debt-payer" class="form-select">
                        <option value="minn0213">minn0213</option>
                        <option value="topyoung0610">topyoung0610</option>
                        <option value="youyouyou.c">youyouyou.c</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">誰欠錢？(債務人)</label>
                    <select id="debt-borrower" class="form-select">
                        <option value="minn0213">minn0213</option>
                        <option value="topyoung0610">topyoung0610</option>
                        <option value="youyouyou.c" selected>youyouyou.c</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">金額</label>
                    <input type="number" id="debt-amount" class="form-control" placeholder="輸入金額">
                </div>
                <div class="mb-3">
                    <label class="form-label">精確日期與時間</label>
                    <input type="datetime-local" id="debt-date" class="form-control">
                </div>
                <button id="submit-debt-btn" class="btn btn-success">送出紀錄</button>
            </div>

            <div class="tab-pane fade card p-4" id="view-debt" role="tabpanel">
                <h4>目前結算結果與還款</h4>
                <p class="text-muted">系統已幫你們自動抵銷債務，可以直接在這裡操作還錢（表格可左右滑動）：</p>
                <div class="table-responsive border">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="white-space: nowrap;">誰欠錢 (債務人)</th>
                                <th style="white-space: nowrap;">該給誰 (債主)</th>
                                <th style="white-space: nowrap;">應還金額</th>
                                <th style="min-width: 260px;">還款操作</th>
                            </tr>
                        </thead>
                        <tbody id="debt-summary-tbody">
                            <tr>
                                <td colspan="4" class="text-center py-3">正在計算中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade card p-4" id="history-debt" role="tabpanel">
                <h4>所有欠款明細</h4>
                <p class="text-muted">這裡顯示大家輸入的每一筆原始紀錄（由新到舊排）：</p>
                <ul id="debt-history-list" class="list-group">
                    <li class="list-group-item text-center">正在讀取中...</li>
                </ul>
            </div>

            <div class="tab-pane fade card p-4" id="add-food" role="tabpanel">
                <h4>紀錄飲食</h4>
                <div class="mb-3">
                    <label class="form-label">吃了什麼？</label>
                    <input type="text" id="food-name" class="form-control" placeholder="例如：麥當勞大麥克">
                </div>
                <div class="mb-3">
                    <label class="form-label">時間</label>
                    <input type="datetime-local" id="food-time" class="form-control">
                </div>
                <button id="submit-food-btn" class="btn btn-warning">新增飲食紀錄</button>
            </div>

            <div class="tab-pane fade" id="food-calendar" role="tabpanel">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtACSJz8x65TwuH3lgD_4-_bokVOX3edQ",
        authDomain: "wteu-3a1f4.firebaseapp.com",
        projectId: "wteu-3a1f4",
        storageBucket: "wteu-3a1f4.firebasestorage.app",
        messagingSenderId: "134165572647",
        appId: "1:134165572647:web:60b4bb8bac3a37bc057202"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const users = {
        "minn0213": "0213",
        "topyoung0610": "0610",
        "youyouyou.c": "0515"
    };
    
    let currentUser = null;
    let calendar; 

    document.getElementById('login-btn').addEventListener('click', () => {
        const user = document.getElementById('login-username').value.trim();
        const pass = document.getElementById('login-password').value.trim();
        
        if (users[user] && users[user] === pass) {
            currentUser = user;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = `歡迎，${user}！`;
            
            loadDebts();
            initCalendar();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
        currentUser = null;
        document.getElementById('main-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-error').classList.add('hidden');
    });

    document.getElementById('submit-debt-btn').addEventListener('click', async () => {
        const payer = document.getElementById('debt-payer').value;
        const borrower = document.getElementById('debt-borrower').value;
        const amount = parseFloat(document.getElementById('debt-amount').value);
        const date = document.getElementById('debt-date').value;

        if (!amount || !date || payer === borrower) {
            alert('請確認金額、日期，且債主與債務人不能是同一人！');
            return;
        }

        try {
            await addDoc(collection(db, "debts"), {
                payer: payer,
                borrower: borrower,
                amount: amount,
                datetime: date,
                recordedBy: currentUser
            });
            alert('欠款紀錄成功！');
            document.getElementById('debt-amount').value = '';
            document.getElementById('debt-date').value = '';
            loadDebts(); 
        } catch (e) {
            console.error("寫入錯誤: ", e);
            alert("寫入資料庫失敗，請確認 Firebase 設定。");
        }
    });

    window.processRepayment = async function(debtor, creditor, amountType, maxAmount, index) {
        let repayAmount = 0;
        
        if (amountType === 'all') {
            repayAmount = parseFloat(maxAmount);
        } else {
            const inputVal = document.getElementById(`repay-input-${index}`).value;
            repayAmount = parseFloat(inputVal);
        }

        if (!repayAmount || repayAmount <= 0 || repayAmount > maxAmount) {
            alert(`請輸入有效的還款金額！(最多不能超過 $${maxAmount})`);
            return;
        }

        if (!confirm(`確定要紀錄「${debtor}」還款 $${repayAmount} 給「${creditor}」嗎？`)) {
            return;
        }

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const localNow = now.toISOString().slice(0,16);

        try {
            await addDoc(collection(db, "debts"), {
                payer: debtor, 
                borrower: creditor, 
                amount: repayAmount,
                datetime: localNow,
                recordedBy: currentUser + " (系統還款操作)" 
            });
            alert('還款成功！系統已更新餘額。');
            loadDebts(); 
        } catch (e) {
            console.error("還款失敗: ", e);
            alert("還款紀錄失敗，請確認網路連線。");
        }
    };

    async function loadDebts() {
        const tbody = document.getElementById('debt-summary-tbody');
        const historyList = document.getElementById('debt-history-list'); 
        
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">正在計算中...</td></tr>';
        historyList.innerHTML = '<li class="list-group-item text-center">正在讀取中...</li>';
        
        try {
            const querySnapshot = await getDocs(collection(db, "debts"));
            let balances = { "minn0213": 0, "topyoung0610": 0, "youyouyou.c": 0 };
            let allDebts = []; 
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                allDebts.push(data); 
                
                if(balances[data.payer] !== undefined && balances[data.borrower] !== undefined){
                    balances[data.payer] += data.amount; 
                    balances[data.borrower] -= data.amount; 
                }
            });

            allDebts.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            historyList.innerHTML = '';
            if (allDebts.length === 0) {
                historyList.innerHTML = '<li class="list-group-item text-center text-muted">目前沒有任何欠款紀錄。</li>';
            } else {
                allDebts.forEach(debt => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    
                    const isRepayment = debt.recordedBy && debt.recordedBy.includes("(系統還款操作)");
                    const actionText = isRepayment ? "還款給" : "幫";
                    const actionColor = isRepayment ? "text-success" : "text-danger";
                    const wordColor = isRepayment ? "text-success fw-bold" : "";

                    li.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="${wordColor}"><strong><span class="text-primary">${debt.payer}</span> ${actionText} <span class="${actionColor}">${debt.borrower}</span> $${debt.amount}</strong></span>
                            <span class="badge bg-secondary">${debt.datetime.replace('T', ' ')}</span>
                        </div>
                        <div class="text-muted small mt-1">紀錄者：${debt.recordedBy}</div>
                    `;
                    historyList.appendChild(li);
                });
            }

            let creditors = [];
            let debtors = [];
            for (let user in balances) {
                if (balances[user] > 0) creditors.push({ user, amount: balances[user] });
                else if (balances[user] < 0) debtors.push({ user, amount: Math.abs(balances[user]) });
            }

            let settlementData = [];
            let i = 0, j = 0;
            while (i < creditors.length && j < debtors.length) {
                let credit = creditors[i];
                let debt = debtors[j];
                let settleAmount = Math.min(credit.amount, debt.amount);
                
                if(settleAmount > 0) {
                    settlementData.push({ debtor: debt.user, creditor: credit.user, amount: settleAmount });
                }
                
                credit.amount -= settleAmount;
                debt.amount -= settleAmount;
                
                if (credit.amount === 0) i++;
                if (debt.amount === 0) j++;
            }

            tbody.innerHTML = '';
            if (settlementData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success py-3 fw-bold fs-5">目前大家互不相欠，太棒了！</td></tr>';
            } else {
                settlementData.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="white-space: nowrap;"><strong>${item.debtor}</strong></td>
                        <td style="white-space: nowrap;"><strong>${item.creditor}</strong></td>
                        <td class="text-danger fw-bold fs-5" style="white-space: nowrap;">$${item.amount}</td>
                        <td>
                            <div class="input-group input-group-sm flex-nowrap" style="min-width: 260px;">
                                <input type="number" class="form-control" id="repay-input-${index}" placeholder="輸入金額" max="${item.amount}">
                                <button class="btn btn-outline-primary" onclick="processRepayment('${item.debtor}', '${item.creditor}', 'partial', ${item.amount}, ${index})">部分還款</button>
                                <button class="btn btn-success" onclick="processRepayment('${item.debtor}', '${item.creditor}', 'all', ${item.amount}, ${index})">一鍵還清</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">讀取失敗，請確認資料庫權限。</td></tr>';
            historyList.innerHTML = '<li class="list-group-item text-center text-danger">讀取明細失敗。</li>';
        }
    }
    document.getElementById('view-debt-tab').addEventListener('click', loadDebts);
    document.getElementById('history-debt-tab').addEventListener('click', loadDebts);

    document.getElementById('submit-food-btn').addEventListener('click', async () => {
        const food = document.getElementById('food-name').value.trim();
        const time = document.getElementById('food-time').value;

        if (!food || !time) {
            alert('請輸入食物名稱與時間！');
            return;
        }

        try {
            await addDoc(collection(db, "foods"), {
                user: currentUser,
                food: food,
                datetime: time
            });
            alert('飲食紀錄成功！');
            document.getElementById('food-name').value = '';
            document.getElementById('food-time').value = '';
            loadFoodsToCalendar(); 
        } catch (e) {
            console.error("寫入錯誤: ", e);
            alert("寫入資料庫失敗。");
        }
    });

    function initCalendar() {
        if (!calendar) {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [] 
            });
            calendar.render();
        }
        loadFoodsToCalendar();
    }

    async function loadFoodsToCalendar() {
        try {
            const querySnapshot = await getDocs(collection(db, "foods"));
            let events = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                events.push({
                    title: `${data.user}: ${data.food}`,
                    start: data.datetime,
                    allDay: false
                });
            });
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        } catch (e) {
            console.error("讀取日曆錯誤:", e);
        }
    }

    document.getElementById('calendar-tab').addEventListener('shown.bs.tab', () => {
        if (calendar) {
            calendar.render();
        }
    });

    window.onload = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const localNow = now.toISOString().slice(0,16);
        document.getElementById('debt-date').value = localNow;
        document.getElementById('food-time').value = localNow;
    };
</script>
</body>
</html>
