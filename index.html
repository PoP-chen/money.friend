<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹è¨˜å¸³èˆ‡é£²é£Ÿæ—¥æ›†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none !important; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; }
        #app-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        #calendar { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* é‡å°æ‰‹æ©Ÿç‰ˆæ»‘å‹•çš„çµ‚æ¥µè§£æ±ºæ–¹æ¡ˆ */
        .custom-table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; 
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: white;
        }
        .custom-table-container table {
            min-width: 650px; 
            margin-bottom: 0;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="main-section">
        <div class="mb-4 mt-2 text-center">
            <h3 class="mb-0 text-primary fw-bold">å¥½å‹è¨˜å¸³èˆ‡é£²é£Ÿæ—¥æ›†</h3>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="add-debt-tab" data-bs-toggle="tab" data-bs-target="#add-debt" type="button" role="tab">æ–°å¢æ¬ æ¬¾</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-debt-tab" data-bs-toggle="tab" data-bs-target="#view-debt" type="button" role="tab">æ¬ æ¬¾ç¸½è¦½(é‚„æ¬¾)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-debt-tab" data-bs-toggle="tab" data-bs-target="#history-debt" type="button" role="tab">æ¬ æ¬¾è©³ç´°ç´€éŒ„</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="add-food-tab" data-bs-toggle="tab" data-bs-target="#add-food" type="button" role="tab">ä»Šæ—¥åƒä»€éº¼</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#food-calendar" type="button" role="tab">é£²é£Ÿæ—¥æ›†</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active card p-4" id="add-debt" role="tabpanel">
                <h4>æ–°å¢ä¸€ç­†æ¬ æ¬¾</h4>
                <div class="mb-3">
                    <label class="form-label">èª°å…ˆä»£å¢Šçš„ï¼Ÿ(å‚µä¸»)</label>
                    <select id="debt-payer" class="form-select">
                        <option value="minn0213">minn0213</option>
                        <option value="topyoung0610">topyoung0610</option>
                        <option value="youyouyou.c">youyouyou.c</option>
                        <option value="iamfrank">iamfrank</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">èª°æ¬ éŒ¢ï¼Ÿ(å‚µå‹™äºº)</label>
                    <select id="debt-borrower" class="form-select">
                        <option value="minn0213">minn0213</option>
                        <option value="topyoung0610">topyoung0610</option>
                        <option value="youyouyou.c" selected>youyouyou.c</option>
                        <option value="iamfrank">iamfrank</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">é‡‘é¡</label>
                    <input type="number" id="debt-amount" class="form-control" placeholder="è¼¸å…¥é‡‘é¡">
                </div>
                <div class="mb-3">
                    <label class="form-label">ç²¾ç¢ºæ—¥æœŸèˆ‡æ™‚é–“</label>
                    <input type="datetime-local" id="debt-date" class="form-control">
                </div>
                <button id="submit-debt-btn" class="btn btn-success w-100">é€å‡ºç´€éŒ„</button>
            </div>

            <div class="tab-pane fade card p-4" id="view-debt" role="tabpanel">
                <h4>ç›®å‰çµç®—çµæœèˆ‡é‚„æ¬¾</h4>
                <p class="text-muted">ç›®å‰çš„æ¬ æ¬¾éƒ½æ˜¯ã€Œä¸€å°ä¸€ç¨ç«‹è¨ˆç®—ã€ï¼Œå¯ä»¥ç›´æ¥åœ¨é€™è£¡æ“ä½œé‚„éŒ¢ï¼ˆå‘å·¦æ»‘å‹•æŸ¥çœ‹æŒ‰éˆ• ğŸ‘‰ï¼‰ï¼š</p>
                <div class="custom-table-container">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>èª°æ¬ éŒ¢ (å‚µå‹™äºº)</th>
                                <th>è©²çµ¦èª° (å‚µä¸»)</th>
                                <th>æ‡‰é‚„é‡‘é¡</th>
                                <th>é‚„æ¬¾æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="debt-summary-tbody">
                            <tr>
                                <td colspan="4" class="text-center py-3">æ­£åœ¨è¨ˆç®—ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade card p-4" id="history-debt" role="tabpanel">
                <h4>æ‰€æœ‰æ¬ æ¬¾æ˜ç´°</h4>
                <p class="text-muted">é€™è£¡é¡¯ç¤ºå¤§å®¶è¼¸å…¥çš„æ¯ä¸€ç­†åŸå§‹ç´€éŒ„ï¼ˆç”±æ–°åˆ°èˆŠæ’ï¼‰ï¼š</p>
                <ul id="debt-history-list" class="list-group">
                    <li class="list-group-item text-center">æ­£åœ¨è®€å–ä¸­...</li>
                </ul>
            </div>

            <div class="tab-pane fade card p-4" id="add-food" role="tabpanel">
                <h4>ç´€éŒ„é£²é£Ÿ</h4>
                <div class="mb-3">
                    <label class="form-label">åƒäº†ä»€éº¼ï¼Ÿ</label>
                    <input type="text" id="food-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šéº¥ç•¶å‹å¤§éº¥å…‹">
                </div>
                <div class="mb-3">
                    <label class="form-label">æ™‚é–“</label>
                    <input type="datetime-local" id="food-time" class="form-control">
                </div>
                <button id="submit-food-btn" class="btn btn-warning w-100">æ–°å¢é£²é£Ÿç´€éŒ„</button>
            </div>

            <div class="tab-pane fade" id="food-calendar" role="tabpanel">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtACSJz8x65TwuH3lgD_4-_bokVOX3edQ",
        authDomain: "wteu-3a1f4.firebaseapp.com",
        projectId: "wteu-3a1f4",
        storageBucket: "wteu-3a1f4.firebasestorage.app",
        messagingSenderId: "134165572647",
        appId: "1:134165572647:web:60b4bb8bac3a37bc057202"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let calendar; 

    document.getElementById('submit-debt-btn').addEventListener('click', async () => {
        const payer = document.getElementById('debt-payer').value;
        const borrower = document.getElementById('debt-borrower').value;
        const amount = parseFloat(document.getElementById('debt-amount').value);
        const date = document.getElementById('debt-date').value;

        if (!amount || !date || payer === borrower) {
            alert('è«‹ç¢ºèªé‡‘é¡ã€æ—¥æœŸï¼Œä¸”å‚µä¸»èˆ‡å‚µå‹™äººä¸èƒ½æ˜¯åŒä¸€äººï¼');
            return;
        }

        try {
            await addDoc(collection(db, "debts"), {
                payer: payer,
                borrower: borrower,
                amount: amount,
                datetime: date,
                recordedBy: "å…±åŒæ“ä½œ" 
            });
            alert('æ¬ æ¬¾ç´€éŒ„æˆåŠŸï¼');
            document.getElementById('debt-amount').value = '';
            loadDebts(); 
        } catch (e) {
            console.error("å¯«å…¥éŒ¯èª¤: ", e);
            alert("å¯«å…¥è³‡æ–™åº«å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase è¨­å®šã€‚");
        }
    });

    window.processRepayment = async function(debtor, creditor, amountType, maxAmount, index) {
        let repayAmount = 0;
        
        if (amountType === 'all') {
            repayAmount = parseFloat(maxAmount);
        } else {
            const inputVal = document.getElementById(`repay-input-${index}`).value;
            repayAmount = parseFloat(inputVal);
        }

        if (!repayAmount || repayAmount <= 0 || repayAmount > maxAmount) {
            alert(`è«‹è¼¸å…¥æœ‰æ•ˆçš„é‚„æ¬¾é‡‘é¡ï¼(æœ€å¤šä¸èƒ½è¶…é $${maxAmount})`);
            return;
        }

        if (!confirm(`ç¢ºå®šè¦ç´€éŒ„ã€Œ${debtor}ã€é‚„æ¬¾ $${repayAmount} çµ¦ã€Œ${creditor}ã€å—ï¼Ÿ`)) {
            return;
        }

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const localNow = now.toISOString().slice(0,16);

        try {
            await addDoc(collection(db, "debts"), {
                payer: debtor, 
                borrower: creditor, 
                amount: repayAmount,
                datetime: localNow,
                recordedBy: "ç³»çµ±é‚„æ¬¾æ“ä½œ" 
            });
            alert('é‚„æ¬¾æˆåŠŸï¼ç³»çµ±å·²æ›´æ–°é¤˜é¡ã€‚');
            loadDebts(); 
        } catch (e) {
            console.error("é‚„æ¬¾å¤±æ•—: ", e);
            alert("é‚„æ¬¾ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šã€‚");
        }
    };

    async function loadDebts() {
        const tbody = document.getElementById('debt-summary-tbody');
        const historyList = document.getElementById('debt-history-list'); 
        
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">æ­£åœ¨è¨ˆç®—ä¸­...</td></tr>';
        historyList.innerHTML = '<li class="list-group-item text-center">æ­£åœ¨è®€å–ä¸­...</li>';
        
        try {
            const querySnapshot = await getDocs(collection(db, "debts"));
            const userList = ["minn0213", "topyoung0610", "youyouyou.c", "iamfrank"];
            let allDebts = []; 
            
            // å»ºç«‹ä¸€å°ä¸€å¸³æœ¬çŸ©é™£
            let pairwise = {};
            userList.forEach(u1 => {
                pairwise[u1] = {};
                userList.forEach(u2 => {
                    pairwise[u1][u2] = 0;
                });
            });
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                allDebts.push(data); 
                
                // å‚µä¸» payer å¹« å‚µå‹™äºº borrower ä»˜éŒ¢ => borrower æ¬  payer éŒ¢
                if(pairwise[data.payer] !== undefined && pairwise[data.borrower] !== undefined) {
                    pairwise[data.payer][data.borrower] += data.amount;
                }
            });

            allDebts.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            historyList.innerHTML = '';
            if (allDebts.length === 0) {
                historyList.innerHTML = '<li class="list-group-item text-center text-muted">ç›®å‰æ²’æœ‰ä»»ä½•æ¬ æ¬¾ç´€éŒ„ã€‚</li>';
            } else {
                allDebts.forEach(debt => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    
                    const isRepayment = debt.recordedBy && debt.recordedBy.includes("ç³»çµ±é‚„æ¬¾æ“ä½œ");
                    const actionText = isRepayment ? "é‚„æ¬¾çµ¦" : "å¹«";
                    const actionColor = isRepayment ? "text-success" : "text-danger";
                    const wordColor = isRepayment ? "text-success fw-bold" : "";

                    li.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="${wordColor}"><strong><span class="text-primary">${debt.payer}</span> ${actionText} <span class="${actionColor}">${debt.borrower}</span> $${debt.amount}</strong></span>
                            <span class="badge bg-secondary">${debt.datetime.replace('T', ' ')}</span>
                        </div>
                    `;
                    historyList.appendChild(li);
                });
            }

            // è¨ˆç®—ä¸€å°ä¸€æœ€çµ‚çµç®—çµæœ
            let settlementData = [];
            for (let i = 0; i < userList.length; i++) {
                for (let j = i + 1; j < userList.length; j++) {
                    let u1 = userList[i];
                    let u2 = userList[j];
                    
                    let u1_owes_u2 = pairwise[u2][u1]; 
                    let u2_owes_u1 = pairwise[u1][u2]; 
                    
                    if (u1_owes_u2 > u2_owes_u1) {
                        settlementData.push({ debtor: u1, creditor: u2, amount: u1_owes_u2 - u2_owes_u1 });
                    } else if (u2_owes_u1 > u1_owes_u2) {
                        settlementData.push({ debtor: u2, creditor: u1, amount: u2_owes_u1 - u1_owes_u2 });
                    }
                }
            }

            tbody.innerHTML = '';
            if (settlementData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success py-3 fw-bold fs-5">ç›®å‰å¤§å®¶äº’ä¸ç›¸æ¬ ï¼Œå¤ªæ£’äº†ï¼</td></tr>';
            } else {
                settlementData.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="white-space: nowrap;"><strong>${item.debtor}</strong></td>
                        <td style="white-space: nowrap;"><strong>${item.creditor}</strong></td>
                        <td class="text-danger fw-bold fs-5" style="white-space: nowrap;">$${item.amount}</td>
                        <td>
                            <div class="input-group input-group-sm flex-nowrap" style="min-width: 250px;">
                                <input type="number" class="form-control" id="repay-input-${index}" placeholder="è¼¸å…¥é‡‘é¡" max="${item.amount}">
                                <button class="btn btn-outline-primary" onclick="processRepayment('${item.debtor}', '${item.creditor}', 'partial', ${item.amount}, ${index})">éƒ¨åˆ†é‚„æ¬¾</button>
                                <button class="btn btn-success" onclick="processRepayment('${item.debtor}', '${item.creditor}', 'all', ${item.amount}, ${index})">ä¸€éµé‚„æ¸…</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æ¬Šé™ã€‚</td></tr>';
            historyList.innerHTML = '<li class="list-group-item text-center text-danger">è®€å–æ˜ç´°å¤±æ•—ã€‚</li>';
        }
    }
    
    document.getElementById('view-debt-tab').addEventListener('click', loadDebts);
    document.getElementById('history-debt-tab').addEventListener('click', loadDebts);

    document.getElementById('submit-food-btn').addEventListener('click', async () => {
        const food = document.getElementById('food-name').value.trim();
        const time = document.getElementById('food-time').value;

        if (!food || !time) {
            alert('è«‹è¼¸å…¥é£Ÿç‰©åç¨±èˆ‡æ™‚é–“ï¼');
            return;
        }

        try {
            await addDoc(collection(db, "foods"), {
                food: food,
                datetime: time
            });
            alert('é£²é£Ÿç´€éŒ„æˆåŠŸï¼');
            document.getElementById('food-name').value = '';
            loadFoodsToCalendar(); 
        } catch (e) {
            console.error("å¯«å…¥éŒ¯èª¤: ", e);
            alert("å¯«å…¥è³‡æ–™åº«å¤±æ•—ã€‚");
        }
    });

    function initCalendar() {
        if (!calendar) {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [] 
            });
            calendar.render();
        }
        loadFoodsToCalendar();
    }

    async function loadFoodsToCalendar() {
        try {
            const querySnapshot = await getDocs(collection(db, "foods"));
            let events = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                events.push({
                    title: data.food, 
                    start: data.datetime,
                    allDay: false
                });
            });
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        } catch (e) {
            console.error("è®€å–æ—¥æ›†éŒ¯èª¤:", e);
        }
    }

    document.getElementById('calendar-tab').addEventListener('shown.bs.tab', () => {
        if (calendar) {
            calendar.render();
        }
    });

    window.onload = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const localNow = now.toISOString().slice(0,16);
        document.getElementById('debt-date').value = localNow;
        document.getElementById('food-time').value = localNow;
        
        loadDebts();
        initCalendar();
    };
</script>
</body>
</html>
