<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友記帳與飲食日曆</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none !important; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; }
        #app-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        #calendar { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="app-container">
    <div id="login-section" class="card p-5 mt-5">
        <h2 class="text-center mb-4">系統登入</h2>
        <div class="mb-3">
            <label class="form-label">帳號</label>
            <input type="text" id="login-username" class="form-control" placeholder="輸入帳號">
        </div>
        <div class="mb-3">
            <label class="form-label">密碼</label>
            <input type="password" id="login-password" class="form-control" placeholder="輸入密碼">
        </div>
        <button id="login-btn" class="btn btn-primary w-100">登入</button>
        <p id="login-error" class="text-danger mt-3 text-center hidden">帳號或密碼錯誤！</p>
    </div>

    <div id="main-section" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
            <h3 id="welcome-msg">歡迎！</h3>
            <button id="logout-btn" class="btn btn-outline-danger btn-sm">登出</button>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="add-debt-tab" data-bs-toggle="tab" data-bs-target="#add-debt" type="button" role="tab">新增欠款</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-debt-tab" data-bs-toggle="tab" data-bs-target="#view-debt" type="button" role="tab">欠款總覽(自動抵銷)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="add-food-tab" data-bs-toggle="tab" data-bs-target="#add-food" type="button" role="tab">今日吃什麼</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#food-calendar" type="button" role="tab">飲食日曆</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active card p-4" id="add-debt" role="tabpanel">
                <h4>新增一筆欠款</h4>
                <div class="mb-3">
                    <label class="form-label">誰先代墊的？(債主)</label>
                    <select id="debt-payer" class="form-select">
                        <option value="minn0213">minn0213</option>
                        <option value="topyoung0610">topyoung0610</option>
                        <option value="youyouyou.c">youyouyou.c</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">誰欠錢？(債務人)</label>
                    <select id="debt-borrower" class="form-select">
                        <option value="minn0213">minn0213</option>
                        <option value="topyoung0610">topyoung0610</option>
                        <option value="youyouyou.c" selected>youyouyou.c</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">金額</label>
                    <input type="number" id="debt-amount" class="form-control" placeholder="輸入金額">
                </div>
                <div class="mb-3">
                    <label class="form-label">精確日期與時間</label>
                    <input type="datetime-local" id="debt-date" class="form-control">
                </div>
                <button id="submit-debt-btn" class="btn btn-success">送出紀錄</button>
            </div>

            <div class="tab-pane fade card p-4" id="view-debt" role="tabpanel">
                <h4>目前結算結果</h4>
                <p class="text-muted">系統已自動幫你們抵銷債務，以下是最終誰該給誰多少錢：</p>
                <ul id="debt-summary-list" class="list-group">
                    <li class="list-group-item text-center">正在計算中...</li>
                </ul>
            </div>

            <div class="tab-pane fade card p-4" id="add-food" role="tabpanel">
                <h4>紀錄飲食</h4>
                <div class="mb-3">
                    <label class="form-label">吃了什麼？</label>
                    <input type="text" id="food-name" class="form-control" placeholder="例如：麥當勞大麥克">
                </div>
                <div class="mb-3">
                    <label class="form-label">時間</label>
                    <input type="datetime-local" id="food-time" class="form-control">
                </div>
                <button id="submit-food-btn" class="btn btn-warning">新增飲食紀錄</button>
            </div>

            <div class="tab-pane fade" id="food-calendar" role="tabpanel">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtACSJz8x65TwuH3lgD_4-_bokVOX3edQ",
        authDomain: "wteu-3a1f4.firebaseapp.com",
        projectId: "wteu-3a1f4",
        storageBucket: "wteu-3a1f4.firebasestorage.app",
        messagingSenderId: "134165572647",
        appId: "1:134165572647:web:60b4bb8bac3a37bc057202"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const users = {
        "minn0213": "0213",
        "topyoung0610": "0610",
        "youyouyou.c": "0515"
    };
    
    let currentUser = null;
    let calendar; 

    document.getElementById('login-btn').addEventListener('click', () => {
        const user = document.getElementById('login-username').value.trim();
        const pass = document.getElementById('login-password').value.trim();
        
        if (users[user] && users[user] === pass) {
            currentUser = user;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = `歡迎，${user}！`;
            
            loadDebts();
            initCalendar();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
        currentUser = null;
        document.getElementById('main-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-error').classList.add('hidden');
    });

    document.getElementById('submit-debt-btn').addEventListener('click', async () => {
        const payer = document.getElementById('debt-payer').value;
        const borrower = document.getElementById('debt-borrower').value;
        const amount = parseFloat(document.getElementById('debt-amount').value);
        const date = document.getElementById('debt-date').value;

        if (!amount || !date || payer === borrower) {
            alert('請確認金額、日期，且債主與債務人不能是同一人！');
            return;
        }

        try {
            await addDoc(collection(db, "debts"), {
                payer: payer,
                borrower: borrower,
                amount: amount,
                datetime: date,
                recordedBy: currentUser
            });
            alert('欠款紀錄成功！');
            document.getElementById('debt-amount').value = '';
            document.getElementById('debt-date').value = '';
            loadDebts(); 
        } catch (e) {
            console.error("寫入錯誤: ", e);
            alert("寫入資料庫失敗，請確認 Firebase 設定。");
        }
    });

    async function loadDebts() {
        const summaryList = document.getElementById('debt-summary-list');
        summaryList.innerHTML = '<li class="list-group-item text-center">正在計算中...</li>';
        
        try {
            const querySnapshot = await getDocs(collection(db, "debts"));
            let balances = { "minn0213": 0, "topyoung0610": 0, "youyouyou.c": 0 };
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if(balances[data.payer] !== undefined && balances[data.borrower] !== undefined){
                    balances[data.payer] += data.amount; 
                    balances[data.borrower] -= data.amount; 
                }
            });

            let creditors = [];
            let debtors = [];
            for (let user in balances) {
                if (balances[user] > 0) creditors.push({ user, amount: balances[user] });
                else if (balances[user] < 0) debtors.push({ user, amount: Math.abs(balances[user]) });
            }

            let settlements = [];
            let i = 0, j = 0;
            while (i < creditors.length && j < debtors.length) {
                let credit = creditors[i];
                let debt = debtors[j];
                let settleAmount = Math.min(credit.amount, debt.amount);
                
                if(settleAmount > 0) {
                    settlements.push(`<strong>${debt.user}</strong> 需給 <strong>${credit.user}</strong> $${settleAmount}`);
                }
                
                credit.amount -= settleAmount;
                debt.amount -= settleAmount;
                
                if (credit.amount === 0) i++;
                if (debt.amount === 0) j++;
            }

            summaryList.innerHTML = '';
            if (settlements.length === 0) {
                summaryList.innerHTML = '<li class="list-group-item text-center text-success">目前大家互不相欠！</li>';
            } else {
                settlements.forEach(text => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item text-center fs-5';
                    li.innerHTML = text;
                    summaryList.appendChild(li);
                });
            }
        } catch (e) {
            summaryList.innerHTML = '<li class="list-group-item text-center text-danger">讀取失敗，請確認資料庫權限。</li>';
        }
    }
    document.getElementById('view-debt-tab').addEventListener('click', loadDebts);

    document.getElementById('submit-food-btn').addEventListener('click', async () => {
        const food = document.getElementById('food-name').value.trim();
        const time = document.getElementById('food-time').value;

        if (!food || !time) {
            alert('請輸入食物名稱與時間！');
            return;
        }

        try {
            await addDoc(collection(db, "foods"), {
                user: currentUser,
                food: food,
                datetime: time
            });
            alert('飲食紀錄成功！');
            document.getElementById('food-name').value = '';
            document.getElementById('food-time').value = '';
            loadFoodsToCalendar(); 
        } catch (e) {
            console.error("寫入錯誤: ", e);
            alert("寫入資料庫失敗。");
        }
    });

    function initCalendar() {
        if (!calendar) {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [] 
            });
            calendar.render();
        }
        loadFoodsToCalendar();
    }

    async function loadFoodsToCalendar() {
        try {
            const querySnapshot = await getDocs(collection(db, "foods"));
            let events = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                events.push({
                    title: `${data.user}: ${data.food}`,
                    start: data.datetime,
                    allDay: false
                });
            });
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        } catch (e) {
            console.error("讀取日曆錯誤:", e);
        }
    }

    document.getElementById('calendar-tab').addEventListener('shown.bs.tab', () => {
        if (calendar) {
            calendar.render();
        }
    });

    window.onload = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const localNow = now.toISOString().slice(0,16);
        document.getElementById('debt-date').value = localNow;
        document.getElementById('food-time').value = localNow;
    };
</script>
</body>
</html>
